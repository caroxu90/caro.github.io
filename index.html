<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的个人全品库</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #3498db;
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            text-align: center;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            background-color: #f0f9ff;
            border-bottom: 3px solid #3498db;
            font-weight: bold;
        }
        
        .tab:hover {
            background-color: #f0f9ff;
        }
        
        .tab-content {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        textarea {
            height: 100px;
            resize: vertical;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .category-filter {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .category-btn {
            background-color: #eee;
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .category-btn.active {
            background-color: #3498db;
            color: white;
        }
        
        .items-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .item-card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border-left: 5px solid #ddd;
            font-size: 0.9em;
        }
        
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .item-card.purchased {
            border-left-color: #2ecc71;
        }
        
        .item-card.wishlist {
            border-left-color: #f1c40f;
        }
        
        .item-card.recommend {
            border-left-color: #e74c3c;
        }
        
        .item-card.not-recommend {
            border-left-color: #95a5a6;
        }
        
        .item-card.no-image {
            display: grid;
            grid-template-columns: 1fr;
        }
        
        .item-card.no-image .item-content {
            padding: 20px;
        }
        
        .item-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background-color: #f9f9f9;
            border-bottom: 1px solid #eee;
        }
        
        .item-content {
            padding: 10px;
        }
        
        .item-title {
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .item-price {
            color: #e74c3c;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 3px;
        }
        
        .item-meta {
            color: #777;
            font-size: 11px;
            margin-bottom: 5px;
        }
        
        .item-description {
            font-size: 11px;
            color: #555;
            margin-bottom: 8px;
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .item-actions {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        .action-btn {
            background-color: #eee;
            color: #333;
            border: none;
            padding: 4px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .action-btn:hover {
            background-color: #ddd;
        }
        
        .action-btn.edit {
            background-color: #3498db;
            color: white;
        }
        
        .action-btn.delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .search-bar {
            display: flex;
            margin-bottom: 20px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
            font-size: 16px;
        }
        
        .search-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            font-size: 16px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            position: sticky;
            top: 0;
            padding: 20px 20px 15px;
            background-color: white;
            border-bottom: 1px solid #eee;
            border-radius: 8px 8px 0 0;
            z-index: 10;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(80vh - 130px);
        }
        
        .modal-footer {
            position: sticky;
            bottom: 0;
            padding: 15px 20px 20px;
            background-color: white;
            border-top: 1px solid #eee;
            border-radius: 0 0 8px 8px;
            text-align: right;
            z-index: 10;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            color: #777;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 15;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 3px;
            color: white;
            font-size: 11px;
            margin-bottom: 6px;
        }
        
        .status-purchased {
            background-color: #2ecc71;
        }
        
        .status-wishlist {
            background-color: #f1c40f;
        }
        
        .status-recommend {
            background-color: #e74c3c;
        }
        
        .status-not-recommend {
            background-color: #95a5a6;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 0;
            color: #777;
        }
        
        .empty-state img {
            width: 120px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        @media (max-width: 1200px) {
            .items-container {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 992px) {
            .items-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .items-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tab {
                padding: 10px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .items-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>我的个人全品库</h1>
            <p>记录生活中的每一件好物</p>
        </div>
    </header>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" data-tab="all">全部</div>
            <div class="tab" data-tab="purchased">已购清单</div>
            <div class="tab" data-tab="wishlist">待购清单</div>
            <div class="tab" data-tab="recommend">种草</div>
            <div class="tab" data-tab="not-recommend">拔草</div>
        </div>
        
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="搜索商品名称、品牌或描述...">
            <button class="search-btn">搜索</button>
        </div>
        
        <div class="category-filter">
            <button class="category-btn active" data-category="all">全部分类</button>
            <button class="category-btn" data-category="beauty">美妆护肤</button>
            <button class="category-btn" data-category="clothing">服饰穿搭</button>
            <button class="category-btn" data-category="digital">婴童用品</button>
            <button class="category-btn" data-category="food">美食</button>
            <button class="category-btn" data-category="home">家居日用</button>
            <button class="category-btn" data-category="other">其他</button>
        </div>
        
        <!-- 固定按钮区 -->
        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <button class="btn" id="fixed-add-btn" style="background-color: #3498db; margin-right: 10px;">添加新商品</button>
                <button class="btn" id="fixed-migrate-btn" style="background-color: #8e44ad; margin-right: 10px;">迁移到云端</button>
                <button class="btn" id="fixed-cleanup-btn" style="background-color: #e67e22; margin-right: 10px; font-size: 12px;">清理云端重复</button>
            </div>
            <div>
                <button class="btn" id="fixed-refresh-btn" style="background-color: #3498db; font-size: 12px; margin-right: 10px;">强制刷新</button>
                <button class="btn" id="fixed-clear-btn" style="background-color: #e74c3c; font-size: 12px; margin-right: 10px;">清理本地数据</button>
                <button class="btn" id="optimize-data-btn" style="background-color: #95a5a6; font-size: 12px;">优化数据存储</button>
            </div>
        </div>
        
        <div class="tab-content active" id="all-content">
            <div class="items-container" id="all-items">
                <!-- 内容将由JavaScript动态生成 -->
                <div class="empty-state">
                    <img src="https://cdn-icons-png.flaticon.com/512/5445/5445197.png" alt="Empty">
                    <h3>暂无商品</h3>
                    <p>点击"添加新商品"开始记录吧！</p>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="purchased-content">
            <div class="items-container" id="purchased-items">
                <!-- 内容将由JavaScript动态生成 -->
            </div>
        </div>
        
        <div class="tab-content" id="wishlist-content">
            <div class="items-container" id="wishlist-items">
                <!-- 内容将由JavaScript动态生成 -->
            </div>
        </div>
        
        <div class="tab-content" id="recommend-content">
            <div class="items-container" id="recommend-items">
                <!-- 内容将由JavaScript动态生成 -->
            </div>
        </div>
        
        <div class="tab-content" id="not-recommend-content">
            <div class="items-container" id="not-recommend-items">
                <!-- 内容将由JavaScript动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 添加/编辑商品弹窗 -->
    <div class="modal" id="item-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">添加新商品</h2>
                <span class="close-btn">&times;</span>
            </div>
            
            <div class="modal-body">
                <form id="item-form">
                    <input type="hidden" id="item-id">
                    
                    <div class="form-group">
                        <label for="item-name">商品名称</label>
                        <input type="text" id="item-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="item-brand">品牌</label>
                        <input type="text" id="item-brand">
                    </div>
                    
                    <div class="form-group">
                        <label for="item-price">价格</label>
                        <input type="number" id="item-price" step="0.01" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="item-category">分类</label>
                        <select id="item-category">
                            <option value="beauty">美妆护肤</option>
                            <option value="clothing">服饰穿搭</option>
                            <option value="digital">婴童用品</option>
                            <option value="food">美食</option>
                            <option value="home">家居日用</option>
                            <option value="other">其他</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="item-status">状态</label>
                        <select id="item-status">
                            <option value="purchased">已购买</option>
                            <option value="wishlist">想买</option>
                            <option value="recommend">推荐(种草)</option>
                            <option value="not-recommend">不推荐(拔草)</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="purchase-date-group">
                        <label for="item-purchase-date">购买日期</label>
                        <input type="date" id="item-purchase-date">
                    </div>
                    
                    <div class="form-group">
                        <label for="item-rating">评分 (1-5星)</label>
                        <input type="number" id="item-rating" min="1" max="5" step="1">
                    </div>
                    
                    <div class="form-group">
                        <label for="item-image">图片URL</label>
                        <input type="text" id="item-image" placeholder="http://example.com/image.jpg">
                    </div>
                    
                    <div class="form-group">
                        <label>图片上传 (拖拽或点击选择)</label>
                        <div id="image-drop-area" style="border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; margin-bottom: 10px;">
                            <p>拖拽图片到此处或点击选择文件</p>
                            <input type="file" id="image-file-input" accept="image/*" style="display: none;">
                            <div id="image-preview" style="margin-top: 10px; max-height: 200px; overflow: hidden; display: none;">
                                <img id="preview-img" style="max-width: 100%; max-height: 180px;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="item-link">购买链接</label>
                        <input type="text" id="item-link" placeholder="http://example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="item-description">描述/使用感受</label>
                        <textarea id="item-description"></textarea>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn" id="save-item-btn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 购买历史弹窗 -->
    <div class="modal" id="purchase-history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">购买历史</h2>
                <span class="close-btn" id="history-close-btn">&times;</span>
            </div>
            
            <div class="modal-body">
                <h3 id="history-item-name" style="margin-bottom: 15px;"></h3>
                <input type="hidden" id="history-item-id">
                
                <div id="purchase-history-list">
                    <!-- 历史记录将动态加载 -->
                </div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <h4>添加新购买记录</h4>
                    <form id="purchase-history-form">
                        <div class="form-group">
                            <label for="purchase-date">购买日期</label>
                            <input type="date" id="purchase-date" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="purchase-price">价格</label>
                            <input type="number" id="purchase-price" step="0.01" min="0" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="purchase-source">购买渠道</label>
                            <input type="text" id="purchase-source" placeholder="如：天猫、京东、线下店等">
                        </div>
                        
                        <div class="form-group">
                            <label for="purchase-notes">备注</label>
                            <textarea id="purchase-notes" placeholder="如：活动价、满减、优惠券等"></textarea>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn" id="add-purchase-btn">添加记录</button>
            </div>
        </div>
    </div>
    
    <!-- Supabase JS客户端 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
    // Supabase配置
    const supabaseUrl = 'https://kaoufifqaojdnandflqp.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imthb3VmaWZxYW9qZG5hbmRmbHFwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MzM4OTIsImV4cCI6MjA2MzMwOTg5Mn0.8HoJvm-M9Y9m-1eY-kf0-hdLSXJDeToR09Jku8EX0lE';
    // 创建Supabase客户端
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    // 商品数据存储
    let items = JSON.parse(localStorage.getItem('itemsData')) || [];
    let currentFilter = 'all';
    let currentCategory = 'all';
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', async function() {
        // 确保数据完整性
        updatePurchaseHistoryData();
        
        // 设置事件监听器
        setupEventListeners();
        
        // 从Supabase加载数据
        try {
            await loadItemsFromSupabase();
        } catch (error) {
            console.error("初始化时加载数据失败:", error);
            // 加载失败时展示本地数据
            renderItems();
        }
    });
    
    // 更新购买历史数据和最新购买日期
    function updatePurchaseHistoryData() {
        items.forEach(item => {
            // 确保每个商品都有purchaseHistory数组
            if (!item.purchaseHistory) {
                item.purchaseHistory = [];
                
                // 如果有购买日期但没有历史记录，创建一条初始记录
                if (item.purchaseDate && item.status === 'purchased') {
                    item.purchaseHistory.push({
                        date: item.purchaseDate,
                        price: item.price || '0',
                        source: '',
                        notes: '初始购买记录'
                    });
                }
            }
            
            // 确保显示最近一次的购买日期
            if (item.purchaseHistory && item.purchaseHistory.length > 0) {
                // 按日期排序
                item.purchaseHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // 更新为最新的购买日期和价格
                item.purchaseDate = item.purchaseHistory[0].date;
                item.price = item.purchaseHistory[0].price;
            }
        });
        
        // 保存更新后的数据
        localStorage.setItem('itemsData', JSON.stringify(items));
    }
    
    // 设置事件监听器
    function setupEventListeners() {
        // 标签切换
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                currentFilter = this.getAttribute('data-tab');
                document.getElementById(`${currentFilter}-content`).classList.add('active');
                
                renderItems();
            });
        });
        
        // 图片拖拽上传
        setupImageDragAndDrop();
        
        // 分类筛选
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentCategory = this.getAttribute('data-category');
                renderItems();
            });
        });
        
        // 固定添加新商品按钮
        document.getElementById('fixed-add-btn').addEventListener('click', function() {
            openItemModal();
        });
        
        // 固定迁移按钮
        document.getElementById('fixed-migrate-btn').addEventListener('click', function() {
            migrateLocalDataToSupabase();
        });
        
        // 固定刷新按钮
        document.getElementById('fixed-refresh-btn').addEventListener('click', function() {
            forceRefresh();
        });
        
        // 固定清理按钮
        document.getElementById('fixed-clear-btn').addEventListener('click', function() {
            clearLocalData();
        });
        
        // 清理云端重复数据按钮
        document.getElementById('fixed-cleanup-btn').addEventListener('click', function() {
            cleanupCloudData();
        });
        
        // 优化数据按钮
        document.getElementById('optimize-data-btn').addEventListener('click', function() {
            optimizeDataStorage();
        });
        
        // 搜索功能
        document.querySelector('.search-btn').addEventListener('click', function() {
            const searchText = document.querySelector('.search-input').value.toLowerCase();
            renderItems(searchText);
        });
        
        // 表单提交
        document.getElementById('save-item-btn').addEventListener('click', function() {
            saveItem();
        });
        
        // 表单按键事件
        document.getElementById('item-form').addEventListener('keydown', function(e) {
            // 阻止回车键提交表单导致页面刷新
            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                // 如果按了回车键，并且不是在多行文本框中，尝试保存
                if (e.target.tagName === 'INPUT') {
                    saveItem();
                }
            }
        });
        
        // 关闭弹窗
        document.querySelector('.close-btn').addEventListener('click', function() {
            document.getElementById('item-modal').style.display = 'none';
        });
        
        // 关闭购买历史弹窗
        document.getElementById('history-close-btn').addEventListener('click', function() {
            document.getElementById('purchase-history-modal').style.display = 'none';
        });
        
        // 添加购买记录按钮
        document.getElementById('add-purchase-btn').addEventListener('click', function() {
            addPurchaseRecord();
        });
        
        // 状态变化显示/隐藏购买日期
        document.getElementById('item-status').addEventListener('change', function() {
            togglePurchaseDateVisibility();
        });
    }
    
    // 设置图片拖拽上传
    function setupImageDragAndDrop() {
        const dropArea = document.getElementById('image-drop-area');
        const fileInput = document.getElementById('image-file-input');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        
        // 点击区域触发文件选择
        dropArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        // 文件选择变化时
        fileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });
        
        // 拖拽事件处理
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => {
                dropArea.style.borderColor = '#3498db';
                dropArea.style.backgroundColor = '#f0f9ff';
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => {
                dropArea.style.borderColor = '#ccc';
                dropArea.style.backgroundColor = '';
            }, false);
        });
        
        dropArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }, false);
        
        // 处理上传的文件
        function handleFiles(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            if (!file.type.match('image.*')) {
                alert('请选择图片文件！');
                return;
            }
            
            // 文件大小限制（2MB）
            if (file.size > 2 * 1024 * 1024) {
                if (confirm('图片大于2MB，是否压缩后再上传？')) {
                    compressImage(file, 0.5, 800); // 降低质量和尺寸更多
                    return;
                }
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // 先测试预览图片是否可以加载
                    const img = new Image();
                    img.onload = function() {
                        // 图片成功加载后再显示预览和设置值
                        previewImg.src = e.target.result;
                        imagePreview.style.display = 'block';
                        document.getElementById('item-image').value = e.target.result;
                    };
                    
                    img.onerror = function() {
                        alert('图片加载失败，可能太大。将自动尝试压缩。');
                        compressImage(file, 0.4, 600);
                    };
                    
                    img.src = e.target.result;
                } catch (err) {
                    alert('处理图片时出错，将尝试更低质量压缩。');
                    compressImage(file, 0.3, 500);
                }
            };
            
            reader.readAsDataURL(file);
        }
        
        // 图片压缩函数优化
        function compressImage(file, quality, maxSize) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    // 创建canvas
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // 如果图片尺寸超过最大尺寸，按比例缩小
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = Math.round(height * maxSize / width);
                            width = maxSize;
                        } else {
                            width = Math.round(width * maxSize / height);
                            height = maxSize;
                        }
                    }
                    
                    // iPhone上处理大图片时可能内存不足，限制最大尺寸
                    const maxAllowedSize = 1200;
                    if (width > maxAllowedSize || height > maxAllowedSize) {
                        const ratio = Math.min(maxAllowedSize / width, maxAllowedSize / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // 在canvas上绘制图片
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // 降低质量更多，确保iPhone可以处理
                    const compressedImage = canvas.toDataURL('image/jpeg', quality);
                    
                    // 将图片显示在预览区
                    previewImg.src = compressedImage;
                    imagePreview.style.display = 'block';
                    
                    // 将Base64编码的图片URL存入输入框
                    document.getElementById('item-image').value = compressedImage;
                    
                    // 显示压缩后大小
                    const originalSize = Math.round(file.size / 1024);
                    const compressedSize = Math.round(compressedImage.length * 0.75 / 1024);
                    console.log(`图片已压缩: ${originalSize}KB -> ${compressedSize}KB, 压缩率: ${Math.round(compressedSize/originalSize*100)}%`);
                };
            };
        }
    }
    
    // 渲染商品列表
    function renderItems(searchText = '') {
        console.log("开始渲染商品列表, 当前有", items.length, "个商品");
        
        // 清空所有容器
        document.getElementById('all-items').innerHTML = '';
        document.getElementById('purchased-items').innerHTML = '';
        document.getElementById('wishlist-items').innerHTML = '';
        document.getElementById('recommend-items').innerHTML = '';
        document.getElementById('not-recommend-items').innerHTML = '';
        
        // 筛选商品
        let filteredItems = items;
        
        // 搜索过滤
        if (searchText) {
            filteredItems = filteredItems.filter(item => 
                (item.name && item.name.toLowerCase().includes(searchText)) || 
                (item.brand && item.brand.toLowerCase().includes(searchText)) || 
                (item.description && item.description.toLowerCase().includes(searchText))
            );
        }
        
        // 分类过滤
        if (currentCategory !== 'all') {
            filteredItems = filteredItems.filter(item => item.category === currentCategory);
        }
        
        // 按购买日期排序，最近的在前面
        filteredItems.sort((a, b) => {
            // 已购买且有日期的排在前面
            if (a.purchaseDate && !b.purchaseDate) return -1;
            if (!a.purchaseDate && b.purchaseDate) return 1;
            
            // 都有购买日期，按日期降序排列（新→旧）
            if (a.purchaseDate && b.purchaseDate) {
                return new Date(b.purchaseDate) - new Date(a.purchaseDate);
            }
            
            // 其它情况保持原顺序
            return 0;
        });
        
        // 检查是否有商品
        if (filteredItems.length === 0) {
            const emptyState = `
                <div class="empty-state">
                    <img src="https://cdn-icons-png.flaticon.com/512/5445/5445197.png" alt="Empty">
                    <h3>暂无商品</h3>
                    <p>点击"添加新商品"开始记录吧！</p>
                </div>
            `;
            
            document.getElementById('all-items').innerHTML = emptyState;
            document.getElementById('purchased-items').innerHTML = emptyState;
            document.getElementById('wishlist-items').innerHTML = emptyState;
            document.getElementById('recommend-items').innerHTML = emptyState;
            document.getElementById('not-recommend-items').innerHTML = emptyState;
            return;
        }
        
        console.log("筛选后有", filteredItems.length, "个商品");
        
        // 渲染商品到当前激活的标签页
        filteredItems.forEach(item => {
            try {
                // 只创建一次元素
                const itemElement = createItemElement(item);
                if (!itemElement) return;
                
                if (currentFilter === 'all') {
                    // 全部标签页：显示所有商品
                    document.getElementById('all-items').appendChild(itemElement);
                } else if (item.status === currentFilter) {
                    // 其他标签页：只显示对应状态的商品
                    document.getElementById(`${currentFilter}-items`).appendChild(itemElement);
                }
            } catch (error) {
                console.error("渲染商品出错:", item, error);
            }
        });
        
        // 添加事件监听器
        addItemEventListeners();
    }
    
    // 创建商品元素
    function createItemElement(item) {
        if (!item || !item.id) {
            console.error("无效的商品数据:", item);
            return null;
        }
    
        const div = document.createElement('div');
        div.className = `item-card ${item.status || ''}`;
        div.setAttribute('data-id', item.id);
        
        let statusText = '';
        let statusClass = '';
        
        switch(item.status) {
            case 'purchased':
                statusText = '已购买';
                statusClass = 'status-purchased';
                break;
            case 'wishlist':
                statusText = '想买';
                statusClass = 'status-wishlist';
                break;
            case 'recommend':
                statusText = '推荐(种草)';
                statusClass = 'status-recommend';
                break;
            case 'not-recommend':
                statusText = '不推荐(拔草)';
                statusClass = 'status-not-recommend';
                break;
            default:
                statusText = '未分类';
                statusClass = '';
        }
        
        let categoryText = '';
        switch(item.category) {
            case 'beauty':
                categoryText = '美妆护肤';
                break;
            case 'clothing':
                categoryText = '服饰穿搭';
                break;
            case 'digital':
                categoryText = '婴童用品';
                break;
            case 'food':
                categoryText = '美食';
                break;
            case 'home':
                categoryText = '家居日用';
                break;
            default:
                categoryText = '其他';
        }
        
        // 为Origins商品使用特殊的绿色背景
        const isOrigins = item.brand && item.brand.includes("Origins");
        const bgColor = isOrigins ? "#618c03" : "#f5f5f5";
        const textColor = isOrigins ? "white" : "#333";
        
        div.innerHTML = `
            ${item.image ? 
            `<img src="${item.image}" class="item-image" alt="${item.name || '未命名商品'}" onerror="this.onerror=null; this.src='https://via.placeholder.com/300x300.png?text=${encodeURIComponent(item.name || '未命名商品')}';">` : 
            `<div class="item-image-placeholder" style="background-color: ${bgColor}; color: ${textColor}; display: flex; align-items: center; justify-content: center; height: 200px; text-align: center; padding: 15px;">
                <div>
                    <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">${item.brand || '未知品牌'}</div>
                    <div style="font-size: 13px;">${item.name || '未命名商品'}</div>
                    <div style="margin-top: 8px; font-size: 16px;">¥${item.price || '未设置'}</div>
                </div>
            </div>`}
            <div class="item-content">
                <span class="status-badge ${statusClass}">${statusText}</span>
                <h3 class="item-title">${item.name || '未命名商品'}</h3>
                <p class="item-price">¥${item.price || '未设置'}</p>
                <p class="item-meta">
                    ${item.brand ? `品牌: ${item.brand}` : ''}
                    ${item.brand && item.rating ? ' | ' : ''}
                    ${item.rating ? `评分: ${'★'.repeat(Math.min(item.rating, 5))}${'☆'.repeat(5-Math.min(item.rating, 5))}` : ''}
                </p>
                <p class="item-meta">
                    分类: ${categoryText}
                    ${item.purchaseDate ? ` | 最近购买: ${item.purchaseDate}` : ''}
                    ${item.purchaseHistory && item.purchaseHistory.length > 1 ? ` (共${item.purchaseHistory.length}次)` : ''}
                </p>
                <p class="item-description">${item.description || '暂无描述'}</p>
                <div class="item-actions">
                    <button class="action-btn edit">编辑</button>
                    <button class="action-btn delete">删除</button>
                    ${item.status === 'purchased' ? 
                      `<button class="action-btn history">购买历史${item.purchaseHistory && item.purchaseHistory.length > 1 ? ` (${item.purchaseHistory.length})` : ''}</button>` : ''}
                    ${item.link ? `<a href="${item.link}" target="_blank" class="action-btn">购买链接</a>` : ''}
                </div>
            </div>
        `;
        
        return div;
    }
    
    // 为商品添加事件监听器
    function addItemEventListeners() {
        // 编辑按钮
        document.querySelectorAll('.action-btn.edit').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemId = this.closest('.item-card').getAttribute('data-id');
                editItem(itemId);
            });
        });
        
        // 删除按钮
        document.querySelectorAll('.action-btn.delete').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemId = this.closest('.item-card').getAttribute('data-id');
                deleteItem(itemId);
            });
        });
        
        // 购买历史按钮
        document.querySelectorAll('.action-btn.history').forEach(btn => {
            btn.addEventListener('click', function() {
                const itemId = this.closest('.item-card').getAttribute('data-id');
                openPurchaseHistoryModal(itemId);
            });
        });
    }
    
    // 打开添加/编辑商品弹窗
    function openItemModal(itemId = null) {
        // 清空表单
        document.getElementById('item-form').reset();
        document.getElementById('item-id').value = '';
        
        // 设置标题
        document.querySelector('.modal-title').textContent = itemId ? '编辑商品' : '添加新商品';
        
        // 如果是编辑，填充商品数据
        if (itemId) {
            const item = items.find(item => item.id == itemId);
            if (item) {
                document.getElementById('item-id').value = item.id;
                document.getElementById('item-name').value = item.name;
                document.getElementById('item-brand').value = item.brand || '';
                document.getElementById('item-price').value = item.price || '';
                document.getElementById('item-category').value = item.category;
                document.getElementById('item-status').value = item.status;
                document.getElementById('item-purchase-date').value = item.purchaseDate || '';
                document.getElementById('item-rating').value = item.rating || '';
                document.getElementById('item-image').value = item.image || '';
                document.getElementById('item-link').value = item.link || '';
                document.getElementById('item-description').value = item.description || '';
                
                // 预览图片
                if (item.image) {
                    document.getElementById('preview-img').src = item.image;
                    document.getElementById('image-preview').style.display = 'block';
                } else {
                    document.getElementById('image-preview').style.display = 'none';
                }
                
                togglePurchaseDateVisibility();
            }
        }
        
        // 显示弹窗
        document.getElementById('item-modal').style.display = 'flex';
    }
    
    // 根据状态切换购买日期的显示
    function togglePurchaseDateVisibility() {
        const status = document.getElementById('item-status').value;
        const purchaseDateGroup = document.getElementById('purchase-date-group');
        
        if (status === 'purchased') {
            purchaseDateGroup.style.display = 'block';
        } else {
            purchaseDateGroup.style.display = 'none';
        }
    }
    
    // 保存商品到Supabase
    async function saveItem() {
        const itemId = document.getElementById('item-id').value;
        const name = document.getElementById('item-name').value;
        const brand = document.getElementById('item-brand').value;
        const price = document.getElementById('item-price').value;
        const category = document.getElementById('item-category').value;
        const status = document.getElementById('item-status').value;
        const purchaseDate = status === 'purchased' ? document.getElementById('item-purchase-date').value : null;
        const rating = document.getElementById('item-rating').value;
        const image = document.getElementById('item-image').value;
        const link = document.getElementById('item-link').value;
        const description = document.getElementById('item-description').value;
        
        // 生成UUID函数
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        if (!name) {
            alert('请输入商品名称');
            document.getElementById('item-name').focus();
            return;
        }
        
        // 确保购买日期有效
        if (status === 'purchased' && !purchaseDate) {
            alert('已购买商品必须填写购买日期');
            document.getElementById('item-purchase-date').focus();
            return;
        }
        
        try {
            const itemData = {
                name,
                brand,
                category,
                status,
                purchase_date: purchaseDate,
                rating,
                image,
                link,
                description,
                price,
                updated_at: new Date().toISOString()
            };
            
            if (itemId) {
                // 更新现有商品
                const { error } = await supabaseClient
                    .from('items')
                    .update(itemData)
                    .eq('id', itemId);
                    
                if (error) throw error;
                
                // 更新本地数组
                const index = items.findIndex(item => item.id === itemId);
                if (index !== -1) {
                    items[index] = {...items[index], ...itemData};
                }
                
                console.log("商品更新成功");
            } else {
                // 添加新商品
                const newItemId = generateUUID();
                itemData.id = newItemId; // 使用UUID作为ID
                itemData.created_at = new Date().toISOString();
                
                // 处理购买历史
                const purchaseHistory = [];
                if (status === 'purchased' && purchaseDate) {
                    purchaseHistory.push({
                        date: purchaseDate,
                        price: price || '0',
                        source: '',
                        notes: '首次购买记录'
                    });
                }
                itemData.purchase_history = purchaseHistory;
                
                // 保存到Supabase
                const { data, error } = await supabaseClient
                    .from('items')
                    .insert([itemData])
                    .select();
                    
                if (error) throw error;
                
                // 将新商品添加到本地数组
                if (data && data.length > 0) {
                    items.push(data[0]);
                } else {
                    // 如果没有返回数据，直接添加本地构建的对象
                    items.push({
                        ...itemData,
                        purchaseDate: purchaseDate, // 转换字段名以匹配本地格式
                        purchaseHistory: purchaseHistory
                    });
                }
                
                console.log("商品添加成功，ID:", itemData.id);
            }
            
            // 关闭弹窗并刷新显示
            document.getElementById('item-modal').style.display = 'none';
            renderItems();
            
        } catch (error) {
            console.error('保存商品时出错:', error);
            alert('保存商品时出错: ' + error.message);
        }
    }
    
    // 编辑商品
    function editItem(itemId) {
        openItemModal(itemId);
    }
    
    // 删除商品
    async function deleteItem(itemId) {
        if (confirm('确定要删除这个商品吗？')) {
            try {
                // 检查ID是否为有效的UUID格式
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                const isValidUuid = uuidRegex.test(itemId);
                
                if (isValidUuid) {
                    // 从Supabase删除
                    const { error } = await supabaseClient
                        .from('items')
                        .delete()
                        .eq('id', itemId);
                        
                    if (error) throw error;
                    console.log("商品从Supabase删除成功");
                } else {
                    console.log("非UUID格式ID，只从本地删除");
                }
                
                // 从本地数组中删除
                items = items.filter(item => item.id != itemId);
                localStorage.setItem('itemsData', JSON.stringify(items));
                
                // 重新渲染页面
                renderItems();
            } catch (error) {
                console.error("删除商品出错:", error);
                alert("删除商品出错: " + error.message);
            }
        }
    }
    
    // 添加一个示例商品 - Origins护肤套装
    function addSampleItem() {
        // 生成UUID函数
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
    
        // 检查是否已经存在示例商品
        if (items.some(item => item.name === "Origins悦木之源菌菇水护肤套装")) {
            return; // 如果存在就不添加
        }
        
        const sampleItem = {
            id: generateUUID(), // 使用UUID作为ID
            name: "Origins悦木之源菌菇水护肤套装",
            brand: "Origins悦木之源",
            price: "270",
            category: "beauty",
            status: "purchased",
            purchaseDate: "2024-05-20",
            rating: "5",
            image: "",
            link: "https://www.origins.com",
            description: "买正送正1套到手¥335，天猫618活动价¥270。抗氧醒肤直击油、闭口问题，山楂菌菇水，调理水油平衡。",
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            purchaseHistory: [
                {
                    date: "2024-05-20",
                    price: "270",
                    source: "天猫官方旗舰店",
                    notes: "618活动价"
                }
            ]
        };
        
        items.push(sampleItem);
        localStorage.setItem('itemsData', JSON.stringify(items));
        renderItems();
    }
    
    // 打开购买历史弹窗
    function openPurchaseHistoryModal(itemId) {
        const item = items.find(item => item.id == itemId);
        if (!item) return;
        
        // 设置商品信息
        document.getElementById('history-item-name').textContent = item.name;
        document.getElementById('history-item-id').value = item.id;
        
        // 渲染购买历史
        renderPurchaseHistory(item);
        
        // 显示弹窗
        document.getElementById('purchase-history-modal').style.display = 'flex';
    }
    
    // 渲染购买历史列表
    function renderPurchaseHistory(item) {
        const historyList = document.getElementById('purchase-history-list');
        historyList.innerHTML = '';
        
        if (!item.purchaseHistory || item.purchaseHistory.length === 0) {
            historyList.innerHTML = '<p style="color: #777; text-align: center; padding: 20px 0;">暂无购买记录</p>';
            return;
        }
        
        // 按日期倒序排列
        const sortedHistory = [...item.purchaseHistory].sort((a, b) => 
            new Date(b.date) - new Date(a.date)
        );
        
        // 创建历史记录列表
        sortedHistory.forEach((record, index) => {
            const recordEl = document.createElement('div');
            recordEl.className = 'purchase-record';
            recordEl.style.padding = '15px';
            recordEl.style.marginBottom = '10px';
            recordEl.style.backgroundColor = '#f9f9f9';
            recordEl.style.borderRadius = '8px';
            recordEl.style.position = 'relative';
            
            recordEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <strong>购买日期: ${record.date}</strong>
                    <span style="color: #e74c3c; font-weight: bold;">¥${record.price}</span>
                </div>
                ${record.source ? `<div>购买渠道: ${record.source}</div>` : ''}
                ${record.notes ? `<div>备注: ${record.notes}</div>` : ''}
                <button class="delete-record-btn" data-index="${index}" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #777; cursor: pointer;">&times;</button>
            `;
            
            historyList.appendChild(recordEl);
        });
        
        // 添加删除记录事件
        document.querySelectorAll('.delete-record-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = this.getAttribute('data-index');
                deletePurchaseRecord(item.id, index);
            });
        });
    }
    
    // 删除购买记录
    function deletePurchaseRecord(itemId, recordIndex) {
        if (!confirm('确定要删除这条购买记录吗？')) return;
        
        const itemIndex = items.findIndex(item => item.id == itemId);
        if (itemIndex === -1) return;
        
        items[itemIndex].purchaseHistory.splice(recordIndex, 1);
        localStorage.setItem('itemsData', JSON.stringify(items));
        
        // 刷新历史记录显示
        renderPurchaseHistory(items[itemIndex]);
        
        // 刷新主界面
        renderItems();
    }
    
    // 添加购买记录
    function addPurchaseRecord() {
        const itemId = document.getElementById('history-item-id').value;
        const date = document.getElementById('purchase-date').value;
        const price = document.getElementById('purchase-price').value;
        const source = document.getElementById('purchase-source').value;
        const notes = document.getElementById('purchase-notes').value;
        
        if (!date || !price) {
            alert('请填写购买日期和价格');
            return;
        }
        
        const itemIndex = items.findIndex(item => item.id == itemId);
        if (itemIndex === -1) return;
        
        // 确保purchaseHistory存在
        if (!items[itemIndex].purchaseHistory) {
            items[itemIndex].purchaseHistory = [];
        }
        
        // 添加新记录
        items[itemIndex].purchaseHistory.push({
            date,
            price,
            source,
            notes
        });
        
        // 更新最新的购买日期和价格
        items[itemIndex].purchaseDate = date;
        items[itemIndex].price = price;
        
        // 保存数据
        localStorage.setItem('itemsData', JSON.stringify(items));
        
        // 清空表单
        document.getElementById('purchase-history-form').reset();
        
        // 刷新历史记录显示
        renderPurchaseHistory(items[itemIndex]);
        
        // 刷新主界面
        renderItems();
    }
    
    // 优化数据存储
    function optimizeDataStorage() {
        if (!confirm('此操作将压缩图片数据并优化存储，可能需要一些时间。继续？')) {
            return;
        }
        
        try {
            let optimized = 0;
            let totalSizeBefore = 0;
            let totalSizeAfter = 0;
            
            // 计算当前存储大小
            const sizeBefore = JSON.stringify(items).length;
            totalSizeBefore = Math.round(sizeBefore / 1024);
            
            // 创建一个新的优化后的数组
            const optimizedItems = items.map(item => {
                // 深拷贝以避免直接修改原数据
                const newItem = {...item};
                
                // 检查并压缩大图片
                if (newItem.image && newItem.image.startsWith('data:image')) {
                    const imgSize = Math.round(newItem.image.length * 0.75 / 1024);
                    
                    if (imgSize > 200) { // 如果图片大于200KB，进行压缩
                        try {
                            // 使用canvas压缩图片
                            const img = new Image();
                            img.src = newItem.image;
                            
                            // 使用同步方式处理
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            // 限制最大尺寸为800px
                            const maxSize = 800;
                            let width = img.width || 800;
                            let height = img.height || 800;
                            
                            if (width > maxSize || height > maxSize) {
                                if (width > height) {
                                    height = Math.round(height * maxSize / width);
                                    width = maxSize;
                                } else {
                                    width = Math.round(width * maxSize / height);
                                    height = maxSize;
                                }
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            // 在canvas上绘制图片
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            // 压缩质量为0.6
                            const compressedImage = canvas.toDataURL('image/jpeg', 0.6);
                            
                            // 更新图片数据
                            newItem.image = compressedImage;
                            optimized++;
                        } catch (e) {
                            console.error('压缩图片失败:', e);
                        }
                    }
                }
                
                return newItem;
            });
            
            // 计算优化后的大小
            const sizeAfter = JSON.stringify(optimizedItems).length;
            totalSizeAfter = Math.round(sizeAfter / 1024);
            
            // 保存优化后的数据
            localStorage.setItem('itemsData', JSON.stringify(optimizedItems));
            items = optimizedItems;
            
            // 显示优化结果
            alert(`数据优化完成!\n\n优化前: ${totalSizeBefore}KB\n优化后: ${totalSizeAfter}KB\n节省空间: ${totalSizeBefore - totalSizeAfter}KB (${Math.round((totalSizeBefore - totalSizeAfter) / totalSizeBefore * 100)}%)\n处理的图片数量: ${optimized}`);
            
            // 刷新显示
            renderItems();
        } catch (error) {
            console.error('优化数据时出错:', error);
            alert('优化数据时出错: ' + error.message);
        }
    }

    // 从Supabase加载数据
    async function loadItemsFromSupabase() {
        try {
            console.log("开始从Supabase加载数据...");
            const { data, error } = await supabaseClient
                .from('items')
                .select('*');
                
            if (error) throw error;
            
            console.log("从Supabase获取到", data ? data.length : 0, "条数据");
            
            // 转换数据格式，使Supabase格式与本地格式匹配
            if (data && data.length > 0) {
                // 使用Map进行去重，确保每个ID只有一个商品
                const itemMap = new Map();
                
                data.forEach(item => {
                    // 如果相同ID的商品已存在，以后加入的为准（通常更新时间更新）
                    itemMap.set(item.id, {
                        id: item.id,
                        name: item.name,
                        brand: item.brand,
                        price: item.price,
                        category: item.category,
                        status: item.status,
                        purchaseDate: item.purchase_date, // 转换字段名
                        rating: item.rating,
                        image: item.image,
                        link: item.link,
                        description: item.description,
                        createdAt: item.created_at,
                        updatedAt: item.updated_at,
                        purchaseHistory: item.purchase_history || []
                    });
                });
                
                // 转换回数组
                items = Array.from(itemMap.values());
                console.log("去重后有", items.length, "条商品数据");
            } else {
                items = [];
                // 如果没有数据，添加示例商品
                addSampleItem();
            }
            
            // 清理本地存储，防止与云端数据混淆
            localStorage.removeItem('itemsData');
            
            console.log("渲染商品列表...");
            renderItems();
        } catch (error) {
            console.error("加载数据出错:", error);
            alert("加载数据出错，请刷新页面重试");
            
            // 加载失败时仍显示本地数据和示例商品
            items = JSON.parse(localStorage.getItem('itemsData')) || [];
            if (items.length === 0) {
                addSampleItem();
            }
            renderItems();
        }
    }

    // 将localStorage数据迁移到Supabase
    async function migrateLocalDataToSupabase() {
        if (confirm('将本地数据迁移到Supabase？这将把您所有本地商品数据上传到云端。')) {
            const localItems = JSON.parse(localStorage.getItem('itemsData')) || [];
            
            if (localItems.length === 0) {
                alert('没有本地数据需要迁移');
                return;
            }
            
            // 生成UUID函数
            function generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }
            
            // 显示进度对话框
            const progressDialog = document.createElement('div');
            progressDialog.style.position = 'fixed';
            progressDialog.style.top = '50%';
            progressDialog.style.left = '50%';
            progressDialog.style.transform = 'translate(-50%, -50%)';
            progressDialog.style.background = 'white';
            progressDialog.style.padding = '20px';
            progressDialog.style.borderRadius = '8px';
            progressDialog.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            progressDialog.style.zIndex = '2000';
            progressDialog.innerHTML = `<h3>正在迁移数据...</h3><p>总进度: <span id="progress-text">0/${localItems.length}</span></p>`;
            document.body.appendChild(progressDialog);
            
            // 格式转换
            const supabaseItems = localItems.map(item => ({
                id: generateUUID(), // 为每个商品生成UUID
                name: item.name,
                brand: item.brand,
                price: item.price,
                category: item.category,
                status: item.status,
                purchase_date: item.purchaseDate,
                rating: item.rating,
                image: item.image,
                link: item.link,
                description: item.description,
                created_at: item.createdAt || new Date().toISOString(),
                updated_at: item.updatedAt || new Date().toISOString(),
                purchase_history: item.purchaseHistory || []
            }));
            
            try {
                // 通过批量插入处理数据
                const { data, error } = await supabaseClient
                    .from('items')
                    .insert(supabaseItems)
                    .select();
                    
                if (error) throw error;
                
                document.body.removeChild(progressDialog);
                alert(`数据迁移成功! ${localItems.length}个商品已上传到Supabase。`);
                
                // 清除本地存储
                localStorage.removeItem('itemsData');
                
                // 迁移成功后加载数据并更新UI
                await loadItemsFromSupabase();
            } catch (error) {
                document.body.removeChild(progressDialog);
                console.error("迁移数据出错:", error);
                alert("迁移数据出错: " + error.message);
            }
        }
    }

    // 清理所有本地数据
    function clearLocalData() {
        if (confirm('确定要清空本地存储的所有数据吗？')) {
            localStorage.removeItem('itemsData');
            items = [];
            renderItems();
            alert('本地数据已清空');
        }
    }

    // 强制刷新和重置
    function forceRefresh() {
        if (confirm('即将清除本地缓存并从云端重新加载数据，继续吗？')) {
            // 清空本地缓存
            localStorage.removeItem('itemsData');
            items = [];
            
            // 重新从Supabase加载数据
            loadItemsFromSupabase();
            
            // 给用户提示
            alert('数据已重置并从云端重新加载。');
        }
    }
    
    // 清理云端重复数据
    async function cleanupCloudData() {
        if (!confirm('即将清理云端重复数据，这可能需要一些时间。继续吗？')) {
            return;
        }
        
        try {
            // 显示加载指示器
            const loadingDiv = document.createElement('div');
            loadingDiv.style.position = 'fixed';
            loadingDiv.style.top = '0';
            loadingDiv.style.left = '0';
            loadingDiv.style.width = '100%';
            loadingDiv.style.height = '100%';
            loadingDiv.style.backgroundColor = 'rgba(0,0,0,0.5)';
            loadingDiv.style.zIndex = '9999';
            loadingDiv.style.display = 'flex';
            loadingDiv.style.justifyContent = 'center';
            loadingDiv.style.alignItems = 'center';
            loadingDiv.style.color = 'white';
            loadingDiv.style.fontSize = '24px';
            loadingDiv.innerHTML = '<div>正在清理数据，请稍候...</div>';
            document.body.appendChild(loadingDiv);
            
            // 1. 获取所有数据
            const { data, error } = await supabaseClient
                .from('items')
                .select('*');
                
            if (error) throw error;
            
            if (!data || data.length === 0) {
                document.body.removeChild(loadingDiv);
                alert('没有发现数据需要清理');
                return;
            }
            
            console.log("获取到", data.length, "条数据");
            
            // 2. 查找重复项
            const itemMap = new Map();
            const duplicates = [];
            
            data.forEach(item => {
                if (itemMap.has(item.id)) {
                    // 找到重复的ID
                    duplicates.push(item.id);
                } else {
                    itemMap.set(item.id, item);
                }
            });
            
            if (duplicates.length === 0) {
                document.body.removeChild(loadingDiv);
                alert('没有发现重复数据');
                return;
            }
            
            console.log("发现", duplicates.length, "个重复ID");
            
            // 3. 删除重复项
            let deletedCount = 0;
            for (const id of duplicates) {
                const itemsWithId = data.filter(item => item.id === id);
                // 保留最后更新的一个（假设更新时间更新的是最新的）
                const sortedItems = itemsWithId.sort((a, b) => 
                    new Date(b.updated_at || 0) - new Date(a.updated_at || 0)
                );
                
                // 删除除了第一个（最新）之外的所有项
                for (let i = 1; i < sortedItems.length; i++) {
                    const { error } = await supabaseClient
                        .from('items')
                        .delete()
                        .eq('id', sortedItems[i].id)
                        .eq('created_at', sortedItems[i].created_at); // 使用复合条件确保精确删除
                        
                    if (!error) {
                        deletedCount++;
                    }
                }
            }
            
            document.body.removeChild(loadingDiv);
            alert(`清理完成！已删除 ${deletedCount} 条重复数据。`);
            
            // 4. 重新加载数据
            await loadItemsFromSupabase();
            
        } catch (error) {
            console.error("清理数据时出错:", error);
            alert("清理数据时出错: " + error.message);
            try {
                const loadingDiv = document.querySelector('div[style*="position: fixed"]');
                if (loadingDiv) {
                    document.body.removeChild(loadingDiv);
                }
            } catch (e) {}
        }
    }
    </script>
</body>
</html>
